<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="/bower_components/paper-datatable-api/paper-datatable-api-column.html">
<link rel="import" href="/bower_components/paper-datatable-api/paper-datatable-api.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">

<link rel="import" href="/bower_components/neon-animation/web-animations.html">

<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">



<dom-module id="my-user">
  <template>
    <style>
      :host {
        display: block;
        padding: 20px;
      }
      .task {
        display: flex;
      }
      .addTask {
        margin-top: 20px;
      }
      .editTask {
        margin-top: 20px;
      }
      .removeTask {
        margin-top: 20px;
      }

      paper-button {
        background-color: lightblue;
      }

    </style>
    <iron-ajax
      id="getTask"
      url="/api/getTask"
      auto
      params="[[param]]"
      handle-as="json"
      last-response="{{taskReponse}}"></iron-ajax>

    <iron-ajax
      id="postTask"
      method="POST"
      content-type="application/json"
      body="{{postBody}}"
      url="/api/postTask"
      handle-as="json"
      last-response="{{taskReponse}}"></iron-ajax>

    <iron-ajax
      id="editTask"
      url="/api/editTask"
      method="POST"
      content-type="application/json"
      body="{{postBody}}"
      handle-as="json"
      last-response="{{taskReponse}}"></iron-ajax>

    <iron-ajax
      id="removeTask"
      url="/api/removeTask"
      method="POST"
      content-type="application/json"
      body="{{postBody}}"
      handle-as="json"
      last-response="{{taskReponse}}"></iron-ajax>

    <div class="userInfo" hidden="[[!param.assignedUserId]]">
      <h4>User ID: [[user.id]] </h4>
      <h4>Username: [[user.name]]</h4>

      <h3>Task Table</h3>
      <paper-datatable-api data="[[taskReponse]]">
        <paper-datatable-api-column draggable-column header="Task ID" property="id">
          <template>
            <span>{{value}}</span>
          </template>
        </paper-datatable-api-column>
        <paper-datatable-api-column header="Task Name" property="name">
          <template>
            <span>{{value}}</span>
          </template>
        </paper-datatable-api-column>
        <paper-datatable-api-column header="Task Status" property="status" editable>
          <template>
            <span>{{value}}</span>
          </template>
        </paper-datatable-api-column>
        <paper-datatable-api-column header="Edit" property="" other-properties='["id"]' editable>
          <template>
            <paper-button raised on-tap="_openEditTaskModal" data-truth$=[[otherValues.id]] style="background-color: orange; width: 120px; margin-top:5px;">Update Status</paper-button>
            <paper-button raised on-tap="_removeTask" data-truth$=[[otherValues.id]] style="background-color:red; width: 120px; margin-top:5px;">Remove Task</paper-button>
          </template>
        </paper-datatable-api-column>
      </paper-datatable-api>

      <paper-dialog id="editTaskModal">
        <h2>Edit Task Form</h2>
        <paper-input type="number" label="Task Id" value="{{taskId}}"></paper-input>
        <paper-dropdown-menu label="Task Status">
          <paper-listbox class="dropdown-content" slot="dropdown-content" attr-for-selected="value" selected="{{taskStatus}}">
            <paper-item value="Pending">Pending</paper-item>
            <paper-item value="In Progress">In Progress</paper-item>
            <paper-item value="Completed">Completed</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <div class="buttons">
          <paper-button raised on-tap="_editTask">Edit</paper-button>
          <paper-button raised on-tap="_closeEditTaskModal">Close</paper-button>
        </div>
      </paper-dialog>

      <paper-dialog id="removeTaskModal">
        <h2>Edit Task Modal</h2>
        <paper-input type="number" label="Task ID" value="{{taskId}}" no-label-float></paper-input>
        <div class="buttons">
          <paper-button raised on-tap="_removeTask" style="background-color:red;">Remove Task</paper-button>
          <paper-button raised on-tap="_closeRemoveTaskModal">Close</paper-button>
        </div>
      </paper-dialog>


      <div class="task">
        <div class="addTask">
          <paper-button raised on-tap="_openAddTaskModal">Add Task</paper-button>
          <paper-dialog id="addTaskModal">
            <h2>Add Task Form</h2>
            <paper-input type="number" label="Task ID" value="{{taskId}}" no-label-float></paper-input>
            <paper-input label="Task Name" value="{{taskName}}" no-label-float></paper-input>
            <paper-dropdown-menu label="Task Status">
              <paper-listbox class="dropdown-content" slot="dropdown-content" attr-for-selected="value" selected="{{taskStatus}}">
                <paper-item value="Pending">Pending</paper-item>
                <paper-item value="In Progress">In Progress</paper-item>
                <paper-item value="Completed">Completed</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
            <div class="buttons">
              <paper-button raised on-tap="_addTask">Submit</paper-button>
              <paper-button raised on-tap="_closeAddTaskModal">Close</paper-button>
            </div>
          </paper-dialog>
        </div>
      </div>
    </div>
  </template>
  <script>
    class MyUser extends Polymer.Element {
      static get is(){
        return 'my-user';
      }
      static get properties(){
        return {
          user: {
            type:Object
          },
          taskReponse: {
            type: Array
          },
          taskId: {
            type: Number
          },
          taskName: {
            type: String
          },
          taskStatus: {
            type: String
          },
          param: {
            type: Object,
            computed: '_createQueryParam(user)'
          },
          postBody: {
            type: Object,
            computed: '_createPostBody(user, taskId, taskName, taskStatus)'
          },
        }
      }

      _createQueryParam(user){
        return {
          assignedUserId: user.id
        }
      }

      _createPostBody(user, taskId, taskName, taskStatus){
        return {
          id: parseInt(taskId),
          name: taskName,
          status: taskStatus,
          assignedUserId: user.id
        }
      }

      _openAddTaskModal(){
        this.taskId = "";
        this.taskName = "";
        this.taskStatus = "";
        this.$.addTaskModal.open();
      }

      _closeAddTaskModal(){
        this.$.addTaskModal.close();
      }

      _addTask(){
        //console.log(this.postBody);
        this.$.postTask.generateRequest();
        this.$.addTaskModal.close();
      }

      _openEditTaskModal(e){
        this.taskId = e.target.dataset.truth;
        this.taskStatus = "";
        this.$.editTaskModal.open();
      }

      _closeEditTaskModal(){
        this.$.editTaskModal.close();
      }

      _editTask(){
        this.$.editTask.generateRequest();
        this.$.editTaskModal.close();
      }

      _openRemoveTaskModal(){
        this.taskId = "";
        this.$.removeTaskModal.open();
      }

      _closeRemoveTaskModal(){
        this.$.removeTaskModal.close();
      }

      _removeTask(e){
        this.taskId = e.target.dataset.truth;
        this.$.removeTask.generateRequest();
      }


    }

    customElements.define(MyUser.is, MyUser);
  </script>
</dom-module>
